# Note: This file was mostly generated by chatgpt.

name: Build and Deploy to itch.io

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  build-and-deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Download Godot 3.6 RC1
      run: |
        wget https://downloads.tuxfamily.org/godotengine/3.6/rc1/Godot_v3.6-rc1_linux_headless.64.zip
        unzip Godot_v3.6-rc1_linux_headless.64.zip -d godot
        sudo mv godot/Godot_v3.6-rc1_linux_headless.64 /usr/local/bin/godot

    - name: Download Godot Export Templates
      run: |
        wget https://downloads.tuxfamily.org/godotengine/3.6/rc1/Godot_v3.6-rc1_export_templates.tpz
        mkdir -p ~/.local/share/godot/templates
        unzip Godot_v3.6-rc1_export_templates.tpz -d ~/.local/share/godot/templates/3.6.rc1

    - name: Export the game to Web
      run: |
        mkdir -p build/web
        godot --export "HTML5" build/web/index.html
      env:
        DISPLAY: ":99"

    - name: Install butler
      run: |
        curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/head/butler.zip
        unzip butler.zip
        sudo mv butler /usr/local/bin/

    - name: Upload to itch.io
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_CREDENTIALS }}
        ITCH_IO_USER: ${{ vars.ITCH_IO_USER }}
        GAME_NAME: ${{ vars.GAME_NAME }}
      run: |
        butler push build/web $ITCH_IO_USER/$GAME_NAME:web
